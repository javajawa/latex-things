\ProvidesPackage{crossword}

% Crossword package
% Copyright 2011 Benedict Harcourt
% License Pending
% Contact: ben.harcourt@harcourtprogramming.co.uk

\usepackage{etoolbox}
\usepackage{tikz}
\usepackage{multicol}
\usepackage{xstring}
\usepackage{forloop}

% Crossword Environment
% It takes two required parameters (width, height) of the grid
% The optional solution flag determines whether the solution or empty grid
% should be displayed
%
% The \cwordheight \cwordwidth \cwordmode commands are defined here.
% If a check finds that they are already defined, ie we're already in a
% crossword environment, or some other package is using these command names.
% Either way, it is considered unsafe to continue, so throw an error.
%
% If the height / width values are not natural numbers, also panic somewhat.
%
% -- start of \begin{crossword}
\newenvironment{crossword}[3][puzzle]{
	% Check for out local environment commands
	% The height of the crossword
	\ifundef{\cwordwidth}%
	{%
		\newcommand{\cwordwidth}{#2}%
	}{%
		\PackageError{crossword}{Already in a crossword environment}%
	}%
	% The height of the crossword
	\ifundef{\cwordheight}%
	{%
		\newcommand{\cwordheight}{#3}%
	}{%
		\PackageError{crossword}{Already in a crossword environment}%
	}%
	% Puzzle / Solution mode
	\ifundef{\cwordmode}%
	{
	}{%
		\PackageError{crossword}{Already in a crossword environment}%
	}%
	\newcounter{clue}%
	\newcounter{squ}%
	\newcommand{\acrossclues}{}%
	\newcommand{\downclues}{}%
	\newcommand{\cwordlen}{}%
	\newsavebox{\cwordgrid}%
	% Begin the grid drawing
	\begin{lrbox}{\cwordgrid}%
	\begin{tikzpicture}%
		\draw[fill=black] (0, 0) rectangle (\cwordwidth, \cwordheight);%
}
% -- end of \begin{crossword}
%
% -- start of \end{crossword}
{
	\end{tikzpicture}
	\end{lrbox}

	\begin{center}
		\resizebox{0.95\columnwidth}{!}{\usebox{\cwordgrid}}

		\renewcommand{\do}[1]{##1 \\ }

		\begin{multicols}{2}
			\begin{flushleft}
			\textbf{Across} \\
			\dolistloop{\acrossclues}

			\columnbreak
			\textbf{Down} \\
			\dolistloop{\downclues}
			\end{flushleft}
		\end{multicols}
	\end{center}
}

% The cwordclue command
% Parameters:
% - x-location (from left to right)
% - y-location (from top to bottom)
% - direction - 0 is across, 1 is down
% - answer
% - clue
\newcommand{\cwordclue}[5]{
	\makeatletter
	\StrLen{#4}[\cwordlen]
	\addtocounter{clue}{1}%

	\ifnumequal{#3}{0}{
		\listxadd{\acrossclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhitea{#1}{#2}{\cwordlen}
	}{
		\listxadd{\downclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhited{#1}{#2}{\cwordlen}
	}
	\draw (#1-1-0.05, \cwordheight+1-#2-0.2) node[right,font=\small] {\arabic{clue}};
	\makeatother
}

\newcommand{\cwordcluestar}[5]{
	\makeatletter
	\StrLen{#4}[\cwordlen]

	\ifnumequal{#3}{0}{
		\listxadd{\acrossclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhitea{#1}{#2}{\cwordlen}
	}{
		\listxadd{\downclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhited{#1}{#2}{\cwordlen}
	}
	\draw (#1-1-0.05, \cwordheight+1-#2-0.2) node[right,font=\small] {\arabic{clue}};
}

\newcommand{\cwordwhitea}[3]{
	\draw[fill=white] (#1-1, \cwordheight-#2) rectangle (#1, \cwordheight-#2+1);
	\ifnumequal{#3}{1}{\relax}{\cwordwhitea{#1+1}{#2}{#3-1}}
}

\newcommand{\cwordwhited}[3]{
	\draw[fill=white] (#1-1, \cwordheight-#2) rectangle (#1, \cwordheight-#2+1);
	\ifnumequal{#3}{1}{\relax}{\cwordwhited{#1}{#2-1}{#3-1}}
}

