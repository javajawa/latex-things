\ProvidesPackage{crossword}

% Crossword package
% Copyright 2011 Benedict Harcourt
% License Pending
% Contact: ben.harcourt@harcourtprogramming.co.uk

\usepackage{etoolbox}
\usepackage{tikz}
\usepackage{multicol}
\usepackage{xstring}

% Counters are global, because that's how I can get it to work
\newcounter{clue}
\newcounter{cwordletter}
% These three lists have to be globals, as they are written to by
% commands of a lower scope (the \cwordclue command, to be precise)
\newcommand{\rootsquares}{}
\newcommand{\acrossclues}{}
\newcommand{\downclues}{}
% Save boxes appear to have some kind of defualt-global which causes
% mutliple grids to break if the save box is not defined externally
\newsavebox{\cwordgrid}

% Crossword Environment
% It takes two required parameters (width, height) of the grid
% The optional solution flag determines whether the solution or empty grid
% should be displayed
%
% The \cwordheight \cwordwidth \cwordmode commands are defined here.
% If a check finds that they are already defined, ie we're already in a
% crossword environment, or some other package is using these command names.
% Either way, it is considered unsafe to continue, so throw an error.
%
% If the height / width values are not natural numbers, also panic somewhat.
%
% -- start of \begin{crossword}
\newenvironment{crossword}[3][puzzle]{
	% Puzzle / Solution mode
	\ifundef{\cwordmode}%
	{
		\renewcommand{\do}[1]{\listadd{\argslist}{##1}}
		\docsvlist{#1}
		\newbool{cwordsoln}
		\ifinlist{solution}{\argslist}{\booltrue{cwordsoln}}{\boolfalse{cwordsoln}}
	}{%
		\PackageError{crossword}{Already in a crossword environment}%
	}%
	\newcommand{\cwordwidth}{#2}%
	\newcommand{\cwordheight}{#3}%
	% Counter for the number of the current clue
	\setcounter{clue}{0}%
	\setcounter{cwordletter}{0}%
	% List placeholders 
	%  - The across and down clue strings
	%  - List of x,y co-ord of squares marked as starting a clue
	\renewcommand{\rootsquares}{}%
	\renewcommand{\acrossclues}{}%
	\renewcommand{\downclues}{}%
	% Command variable for length of current answer
	\newcommand{\cwordlen}{}%
	% Create a drawing box for the grid
	\savebox{\cwordgrid}{}%
	% Begin the grid drawing
	\begin{lrbox}{\cwordgrid}%
	\begin{tikzpicture}%
		\draw[fill=black] (0, 0) rectangle (\cwordwidth, \cwordheight);%
}
% -- end of \begin{crossword}
%
% -- start of \end{crossword}
{
	\end{tikzpicture}
	\end{lrbox}

	\begin{center}
		\resizebox{0.95\columnwidth}{!}{\usebox{\cwordgrid}}

		\ifbool{cwordsoln}{}{
			\renewcommand{\do}[1]{##1 \\ }

			\begin{multicols}{2}
				\begin{flushleft}
				\textbf{Across} \\
				\dolistloop{\acrossclues}

				\columnbreak
				\textbf{Down} \\
				\dolistloop{\downclues}
				\end{flushleft}
			\end{multicols}
		}
	\end{center}
}

% The cwordclue command
% Parameters:
% - x-location (from left to right)
% - y-location (from top to bottom)
% - direction - 0 is across, 1 is down
% - answer
% - clue
%
% TODO: Throw error is not used in crossword environment
\newcommand{\cwordclue}[5]{
	\StrLen{#4}[\cwordlen]

	\xifinlist{#1*\cwordwidth+#2}{\rootsquares}{
		% Do anything here?
	}{
		\addtocounter{clue}{1}%
		\listxadd{\rootsquares}{#1*\cwordwidth+#2}
	}

	\ifnumequal{#3}{0}{
		\listxadd{\acrossclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhitea{#1}{#2}{\cwordlen}{#4}{\cwordlen}
	}{
		\listxadd{\downclues}{\arabic{clue}. #5 (\cwordlen)}
		\cwordwhited{#1}{#2}{\cwordlen}{#4}
	}
	\ifbool{cwordsoln}{}{
		\draw (#1-1-0.05, \cwordheight+1-#2-0.2) node[right,font=\small] {\arabic{clue}};
	}
}

\newcommand{\cwordwhitea}[4]{
	\addtocounter{cwordletter}{1}
	\draw[fill=white] (#1-1, \cwordheight-#2) rectangle (#1, \cwordheight-#2+1);
	\ifbool{cwordsoln}{
		\draw (#1-1+0.5, \cwordheight-#2+0.5) node[font=\large] {\StrChar{#4}{\value{cwordletter}}};
	}{%
	}%
	\ifnumequal{#3}{1}{
		\setcounter{cwordletter}{0}
	}{
		\cwordwhitea{#1+1}{#2}{#3-1}{#4}
	}
}

\newcommand{\cwordwhited}[4]{
	\addtocounter{cwordletter}{1}
	\draw[fill=white] (#1-1, \cwordheight-#2) rectangle (#1, \cwordheight-#2+1);
	\ifbool{cwordsoln}{	
		\draw (#1-1+0.5, \cwordheight-#2+0.5) node[font=\large] {\StrChar{#4}{\value{cwordletter}}};
	}{%
	}%
	\ifnumequal{#3}{1}{
		\setcounter{cwordletter}{0}
	}{
		\cwordwhited{#1}{#2-1}{#3-1}{#4}
	}
}

